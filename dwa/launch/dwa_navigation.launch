<?xml version="1.0"?>
<launch>
  <!-- ===================================================== -->
  <!-- DWA Navigation Launch -->
  <!-- DWA 기반 자율 주행 네비게이션 -->
  <!-- -->
  <!-- NOTE: 시뮬레이션 환경에서 사용하려면 먼저 -->
  <!-- gazebo_simulation 패키지를 실행하세요: -->
  <!-- roslaunch gazebo_simulation gazebo_spawn.launch -->
  <!-- ===================================================== -->

  <!-- Arguments -->
  <arg name="enable_rviz" default="true"/>
  <arg name="rviz_config" default="$(find dwa)/rviz/dwa.rviz"/>
  <arg name="odom_topic" default="odom"/>
  <arg name="lidar_topic" default="/ouster/points"/>
  <arg name="enable_waypoint_manager" default="false"/>

  <!-- ===== 포인트 클라우드 처리 파이프라인 ===== -->
  <node pkg="nodelet" type="nodelet" name="pcl_manager" args="manager" output="screen"/>

  <!-- Ouster 데이터 다운샘플링을 위한 VoxelGrid 필터 -->
  <node pkg="nodelet" type="nodelet" name="voxel_grid" args="load pcl/VoxelGrid pcl_manager" output="screen">
    <remap from="~input" to="/ouster/points"/>
    <remap from="~output" to="/points_filtered"/>
    <param name="leaf_size" value="0.10"/>
    <param name="filter_field_name" value="z"/>
    <param name="filter_limit_min" value="-0.8"/>
    <param name="filter_limit_max" value="0.5"/>
  </node>

  <!-- ===== PointCloud2 to LaserScan 변환 ===== -->
  <node pkg="pointcloud_to_laserscan" type="pointcloud_to_laserscan_node" name="pointcloud_to_laserscan">
    <!-- 입력 PointCloud2 토픽 (필터링된 데이터 사용) -->
    <remap from="cloud_in" to="/points_filtered"/>
    <remap from="scan" to="/scan"/>

    <!-- 변환 파라미터 -->
    <param name="target_frame" value="os_lidar"/>
    <param name="transform_tolerance" value="0.01"/>
    <param name="min_height" value="-0.5"/>
    <param name="max_height" value="2.0"/>

    <param name="angle_min" value="-3.14159"/>
    <param name="angle_max" value="3.14159"/>
    <param name="angle_increment" value="0.0087"/>
    <param name="scan_time" value="0.1"/>
    <param name="range_min" value="0.3"/>
    <param name="range_max" value="75.0"/>

    <param name="use_inf" value="true"/>
    <param name="inf_epsilon" value="1.0"/>
  </node>

  <!-- ===== move_base 네비게이션 스택 ===== -->
  <node pkg="move_base" type="move_base" respawn="false" name="move_base" output="screen">
    <!-- 토픽 리매핑 -->
    <remap from="odom" to="$(arg odom_topic)"/>
    <remap from="cmd_vel" to="husky_velocity_controller/cmd_vel"/>

    <!-- 파라미터 로드 -->
    <rosparam file="$(find dwa)/config/move_base_params.yaml" command="load"/>
    <rosparam file="$(find dwa)/config/global_costmap_params.yaml" command="load"/>
    <rosparam file="$(find dwa)/config/local_costmap_params.yaml" command="load"/>
    <rosparam file="$(find dwa)/config/costmap_common_params.yaml" command="load" ns="global_costmap"/>
    <rosparam file="$(find dwa)/config/costmap_common_params.yaml" command="load" ns="local_costmap"/>
    <rosparam file="$(find dwa)/config/global_planner_params.yaml" command="load"/>
    <rosparam file="$(find dwa)/config/local_planner_params.yaml" command="load"/>

    <!-- 플래너 선택 -->
    <param name="base_global_planner" value="global_planner/GlobalPlanner"/>
    <param name="base_local_planner" value="dwa_local_planner/DWAPlannerROS"/>
  </node>

  <!-- ===== Waypoint Manager ===== -->
  <!-- Kakao API 경로를 사용할 때만 활성화 -->
  <node if="$(arg enable_waypoint_manager)" pkg="dwa" type="waypoint_manager.py" name="waypoint_manager" output="screen">
    <rosparam file="$(find dwa)/config/waypoint_manager_params.yaml" command="load"/>
  </node>

  <!-- ===== RViz 시각화 ===== -->
  <node if="$(arg enable_rviz)" name="rviz" pkg="rviz" type="rviz"
        args="-d $(arg rviz_config)"
        output="screen"/>

</launch>
