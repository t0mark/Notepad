<?xml version="1.0"?>
<launch>

  <!-- ===== Gazebo 시뮬레이션용 DWA 네비게이션 테스트 ===== -->
  <!-- husky_gazebo_spawn.launch 실행 후 이 파일 실행 -->

  <param name="/use_sim_time" value="true" />

  <!-- ===== 로봇 상태 발행 ===== -->
  <!-- Gazebo Skid Steer Plugin이 바퀴 제어 및 joint_state 발행 -->
  <!-- Robot state publisher가 joint_state → TF 변환 -->
  <node name="robot_state_publisher" pkg="robot_state_publisher" type="robot_state_publisher">
    <param name="use_tf_static" value="false"/>
    <param name="publish_frequency" value="50"/>
  </node>

  <!-- ===== 포인트 클라우드 처리 파이프라인 ===== -->
  <node pkg="nodelet" type="nodelet" name="pcl_manager" args="manager" output="screen"/>

  <!-- Ouster 데이터 다운샘플링 -->
  <node pkg="nodelet" type="nodelet" name="voxel_grid" args="load pcl/VoxelGrid pcl_manager" output="screen">
    <remap from="~input" to="/ouster/points" />
    <remap from="~output" to="/points_filtered" />
    <param name="leaf_size" value="0.1" />
    <param name="filter_field_name" value="z" />
    <param name="filter_limit_min" value="-0.5" />
    <param name="filter_limit_max" value="2.0" />
  </node>

  <!-- PointCloud2를 LaserScan으로 변환 -->
  <node pkg="pointcloud_to_laserscan" type="pointcloud_to_laserscan_node" name="pointcloud_to_laserscan">
    <remap from="cloud_in" to="/points_filtered"/>
    <remap from="scan" to="/scan"/>
    <param name="angle_min" value="-3.14159"/>
    <param name="angle_max" value="3.14159"/>
    <param name="min_height" value="-0.5"/>
    <param name="max_height" value="2.0"/>
    <param name="angle_increment" value="0.01"/>
    <param name="scan_time" value="0.1"/>
    <param name="range_min" value="0.3"/>
    <param name="range_max" value="50.0"/>
    <param name="use_inf" value="true"/>
  </node>

  <!-- ===== Static TF for odom ===== -->
  <!-- Gazebo Skid Steer Plugin이 odom 발행 -->
  <node pkg="tf2_ros" type="static_transform_publisher" name="map_to_odom_broadcaster"
        args="0 0 0 0 0 0 map odom" />

  <!-- ===== DWA Navigation (Move Base) ===== -->
  <node pkg="move_base" type="move_base" respawn="false" name="move_base" output="screen">
    <!-- cmd_vel 토픽 리매핑 (Skid Steer Plugin이 듣는 토픽으로) -->
    <remap from="cmd_vel" to="husky_velocity_controller/cmd_vel"/>

    <!-- Costmap 설정 -->
    <rosparam file="$(find dwa)/config/costmap_common_params.yaml" command="load" ns="global_costmap" />
    <rosparam file="$(find dwa)/config/costmap_common_params.yaml" command="load" ns="local_costmap" />
    <rosparam file="$(find dwa)/config/local_costmap_params.yaml" command="load" />
    <rosparam file="$(find dwa)/config/global_costmap_params.yaml" command="load" />
    <rosparam file="$(find dwa)/config/robot_dynamics_params.yaml" command="load" />
    <rosparam file="$(find dwa)/config/path_planning_params.yaml" command="load" />

    <!-- Gazebo 시뮬레이션용 프레임 override (config 파일은 utm_local 유지) -->
    <param name="global_costmap/global_frame" value="odom"/>
    <param name="local_costmap/global_frame" value="odom"/>
    <param name="DWAPlannerROS/global_frame_id" value="odom"/>
  </node>

  <!-- ===== RViz 시각화 ===== -->
  <node name="rviz" pkg="rviz" type="rviz"
        args="-d $(find dwa)/rviz/dwa.rviz"
        output="screen"/>

</launch>
